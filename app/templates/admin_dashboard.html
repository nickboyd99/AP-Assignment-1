{% extends "base.html" %}
{% block content %}
<div class="container py-5">
  <div class="d-flex justify-content-between align-items-start">
    <div>
      <h2 class="h4 fw-semibold mb-1">Management dashboard</h2>
      <div class="text-muted small">Approvals, utilisation, and operational insight</div>
    </div>
    {% if current_user.role == "admin" %}
      <a class="btn btn-outline-light" href="{{ url_for('admin.export_bookings') }}">Export bookings (CSV)</a>
    {% endif %}
  </div>

  <div class="row g-3 mt-3">
    <div class="col-md-3">
      <div class="card p-3">
        <div class="text-muted small">Cancellations (30 days)</div>
        <div class="fs-3 fw-semibold">{{ cancellations_30 }}</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card p-3">
        <div class="text-muted small">No-shows (30 days)</div>
        <div class="fs-3 fw-semibold">{{ no_shows_30 }}</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card p-3">
        <div class="text-muted small">Out of service</div>
        <div class="fs-3 fw-semibold">{{ out_of_service }}</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card p-3">
        <div class="text-muted small">Utilisation window</div>
        <div class="fs-6 fw-semibold">{{ util.since.strftime("%Y-%m-%d") }} → now</div>
      </div>
    </div>
  </div>

  <div class="row g-3 mt-1">
    <div class="col-lg-7">
      <div class="card p-3">
        <div class="d-flex justify-content-between align-items-center">
          <div class="fw-semibold">Booking approvals</div>
          <div>
            <a class="btn btn-sm {% if status=='pending' %}btn-primary{% else %}btn-outline-light{% endif %}" href="{{ url_for('admin.dashboard', status='pending') }}">Pending</a>
            <a class="btn btn-sm {% if status=='approved' %}btn-primary{% else %}btn-outline-light{% endif %}" href="{{ url_for('admin.dashboard', status='approved') }}">Approved</a>
            <a class="btn btn-sm {% if status=='rejected' %}btn-primary{% else %}btn-outline-light{% endif %}" href="{{ url_for('admin.dashboard', status='rejected') }}">Rejected</a>
          </div>
        </div>

        <div class="table-responsive mt-3">
          <table class="table table-dark table-hover align-middle mb-0">
            <thead>
              <tr>
                <th>ID</th>
                <th>Requester</th>
                <th>Window (UTC)</th>
                <th>Machines</th>
                <th class="text-end">Action</th>
              </tr>
            </thead>
            <tbody>
              {% for b in pending_bookings %}
                <tr>
                  <td>#{{ b.id }}</td>
                  <td class="small">
                    <div>{{ b.requester.email }}</div>
                    <div class="text-muted">{{ b.requester.team }}</div>
                  </td>
                  <td class="small">
                    <div>{{ b.start_at.strftime("%Y-%m-%d %H:%M") }}</div>
                    <div class="text-muted">to {{ b.end_at.strftime("%Y-%m-%d %H:%M") }}</div>
                  </td>
                  <td class="small">
                    {% for it in b.items %}
                      <span class="badge tm-pill me-1 mb-1">{{ it.machine.name }}</span>
                    {% endfor %}
                  </td>
                  <td class="text-end">
                    {% if b.status == "pending" %}
                      <form method="post" action="{{ url_for('admin.approve_booking', booking_id=b.id) }}" class="d-inline">
                        <button class="btn btn-sm btn-success">Approve</button>
                      </form>
                      <button class="btn btn-sm btn-outline-light" data-bs-toggle="collapse" data-bs-target="#rej{{ b.id }}">Reject</button>
                      <div class="collapse mt-2" id="rej{{ b.id }}">
                        <form method="post" action="{{ url_for('admin.reject_booking', booking_id=b.id) }}">
                          <input class="form-control form-control-sm" name="note" placeholder="Reason (optional)">
                          <button class="btn btn-sm btn-danger mt-2">Confirm reject</button>
                        </form>
                      </div>
                    {% else %}
                      <span class="text-muted small">—</span>
                    {% endif %}
                  </td>
                </tr>
              {% else %}
                <tr><td colspan="5" class="text-muted">No items in this list.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <div class="card p-3 mt-3">
        <div class="fw-semibold">Upcoming bookings (next 50)</div>
        <div class="table-responsive mt-3">
          <table class="table table-dark table-hover align-middle mb-0">
            <thead>
              <tr><th>ID</th><th>Status</th><th>Start</th><th>End</th></tr>
            </thead>
            <tbody>
              {% for b in upcoming %}
                <tr>
                  <td>#{{ b.id }}</td>
                  <td><span class="badge tm-pill">{{ b.status }}</span></td>
                  <td class="small">{{ b.start_at.strftime("%Y-%m-%d %H:%M") }}</td>
                  <td class="small">{{ b.end_at.strftime("%Y-%m-%d %H:%M") }}</td>
                </tr>
              {% else %}
                <tr><td colspan="4" class="text-muted">No upcoming bookings.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

    </div>

    <div class="col-lg-5">
      <div class="card p-3">
        <div class="fw-semibold">Utilisation by category (30 days)</div>
        <canvas id="catChart" height="220" class="mt-3"></canvas>
      </div>
      <div class="card p-3 mt-3">
        <div class="fw-semibold">Top machines by booked hours (30 days)</div>
        <canvas id="machineChart" height="240" class="mt-3"></canvas>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>
    const util = {{ util | tojson }};
    const catLabels = util.by_category.map(x => x.category);
    const catData = util.by_category.map(x => x.hours);

    new Chart(document.getElementById('catChart'), {
      type: 'bar',
      data: { labels: catLabels, datasets: [{ label: 'Hours booked', data: catData }] },
      options: { responsive: true, plugins: { legend: { display: false } } }
    });

    const mLabels = util.by_machine.map(x => x.machine);
    const mData = util.by_machine.map(x => x.hours);

    new Chart(document.getElementById('machineChart'), {
      type: 'bar',
      data: { labels: mLabels, datasets: [{ label: 'Hours booked', data: mData }] },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: { x: { ticks: { maxRotation: 70, minRotation: 40 } } }
      }
    });
  </script>
{% endblock %}
